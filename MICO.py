# *************************************************************************** #
#            Multi-Agent Infrastructure Configuration Optimizer (MICO)        #
#                               Senne Deproost                                #
#                            senne.deproost@vub.be                            #
# *************************************************************************** #

from sys import argv
import random as r
import numpy as np
from tinydb import TinyDB, Query
import globals as g
import infrastructure as i
import coordination_graph as cg
import banner as b
import log as l
import WISDEM.FLORIS_SE.NREL5_calc as f

b.printBanner()

args = argv
argc = len(args)

extension = ".json"

wind = {"angle": 180, "speed": 8.1}

preCalcs = [[[[1600.2776271675173, 491.63044018723537, 258.6621009117687], [1600.2776271675173, 491.63044018723537, 270.2858110911398], [1600.2776271675173, 491.63044018723537, 277.36285596187656], [1600.2776271675173, 491.63044018723537, 279.7291052908205], [1600.2776271675173, 491.63044018723537, 277.36285596187656], [1600.2776271675173, 491.63044018723537, 270.2858110911398], [1600.2776271675173, 491.63044018723537, 258.6621009117687]], [[1600.2776271675173, 511.7933376351407, 209.1733174459612], [1600.2776271675173, 511.7933376351407, 219.0408614306145], [1600.2776271675173, 511.7933376351407, 224.99367666514064], [1600.2776271675173, 511.7933376351407, 226.99048853382587], [1600.2776271675173, 511.7933376351407, 224.99367666514064], [1600.2776271675173, 511.7933376351407, 219.0408614306145], [1600.2776271675173, 511.7933376351407, 209.1733174459612]], [[1600.2776271675173, 523.9284672005523, 190.62303077347443], [1600.2776271675173, 523.9284672005523, 199.74160320729882], [1600.2776271675173, 523.9284672005523, 205.2811388165715], [1600.2776271675173, 523.9284672005523, 207.15233926600283], [1600.2776271675173, 523.9284672005523, 205.2811388165715], [1600.2776271675173, 523.9284672005523, 199.74160320729882], [1600.2776271675173, 523.9284672005523, 190.62303077347443]], [[1600.2776271675173, 528.0172415060847, 200.40893120395086], [1600.2776271675173, 528.0172415060847, 209.8584084221492], [1600.2776271675173, 528.0172415060847, 215.68177489808434], [1600.2776271675173, 528.0172415060847, 217.64886698806643], [1600.2776271675173, 528.0172415060847, 215.68177489808434], [1600.2776271675173, 528.0172415060847, 209.8584084221492], [1600.2776271675173, 528.0172415060847, 200.40893120395086]], [[1600.2776271675173, 523.9284672005523, 243.43741411087572], [1600.2776271675173, 523.9284672005523, 254.43216940985513], [1600.2776271675173, 523.9284672005523, 261.1580513637468], [1600.2776271675173, 523.9284672005523, 263.42832632188276], [1600.2776271675173, 523.9284672005523, 261.1580513637468], [1600.2776271675173, 523.9284672005523, 254.43216940985513], [1600.2776271675173, 523.9284672005523, 243.43741411087572]], [[1600.2776271675173, 511.7933376351407, 307.78151735058543], [1600.2776271675173, 511.7933376351407, 321.13535377452257], [1600.2776271675173, 511.7933376351407, 329.34365205480606], [1600.2776271675173, 511.7933376351407, 332.11282456233954], [1600.2776271675173, 511.7933376351407, 329.34365205480606], [1600.2776271675173, 511.7933376351407, 321.13535377452257], [1600.2776271675173, 511.7933376351407, 307.78151735058543]], [[1600.2776271675173, 491.63044018723537, 387.2289338220013], [1600.2776271675173, 491.63044018723537, 403.557946135173], [1600.2776271675173, 491.63044018723537, 413.42425465791473], [1600.2776271675173, 491.63044018723537, 416.75032931732136], [1600.2776271675173, 491.63044018723537, 413.42425465791473], [1600.2776271675173, 491.63044018723537, 403.557946135173], [1600.2776271675173, 491.63044018723537, 387.2289338220013]]], [[[1659.5599978012335, 435.01655435828025, 234.92227865915964], [1659.5599978012335, 435.01655435828025, 245.7127939030409], [1659.5599978012335, 435.01655435828025, 252.21727730405703], [1659.5599978012335, 435.01655435828025, 254.40845393459915], [1659.5599978012335, 435.01655435828025, 252.21727730405703], [1659.5599978012335, 435.01655435828025, 245.7127939030409], [1659.5599978012335, 435.01655435828025, 234.92227865915964]], [[1659.5599978012335, 452.98835526004683, 186.15025588012583], [1659.5599978012335, 452.98835526004683, 195.14121560040638], [1659.5599978012335, 452.98835526004683, 200.5752641599102], [1659.5599978012335, 452.98835526004683, 202.4030920421482], [1659.5599978012335, 452.98835526004683, 200.5752641599102], [1659.5599978012335, 452.98835526004683, 195.14121560040638], [1659.5599978012335, 452.98835526004683, 186.15025588012583]], [[1659.5599978012335, 464.0172776748975, 167.91729008777608], [1659.5599978012335, 464.0172776748975, 176.24892515675182], [1659.5599978012335, 464.0172776748975, 181.25342139127102], [1659.5599978012335, 464.0172776748975, 182.94447664625412], [1659.5599978012335, 464.0172776748975, 181.25342139127102], [1659.5599978012335, 464.0172776748975, 176.24892515675182], [1659.5599978012335, 464.0172776748975, 167.91729008777608]], [[1659.5599978012335, 467.73502451819246, 177.09557483109282], [1659.5599978012335, 467.73502451819246, 185.64631106504632], [1659.5599978012335, 467.73502451819246, 190.91948284855272], [1659.5599978012335, 467.73502451819246, 192.70133454882685], [1659.5599978012335, 467.73502451819246, 190.91948284855272], [1659.5599978012335, 467.73502451819246, 185.64631106504632], [1659.5599978012335, 467.73502451819246, 177.09557483109282]], [[1659.5599978012335, 464.0172776748975, 218.72100600064238], [1659.5599978012335, 464.0172776748975, 228.8060137988527], [1659.5599978012335, 464.0172776748975, 234.98655888094072], [1659.5599978012335, 464.0172776748975, 237.0734560137346], [1659.5599978012335, 464.0172776748975, 234.98655888094072], [1659.5599978012335, 464.0172776748975, 228.8060137988527], [1659.5599978012335, 464.0172776748975, 218.72100600064238]], [[1659.5599978012335, 452.98835526004683, 281.3368332039586], [1659.5599978012335, 452.98835526004683, 293.74597328471987], [1659.5599978012335, 452.98835526004683, 301.3776157553286], [1659.5599978012335, 452.98835526004683, 303.92724194293], [1659.5599978012335, 452.98835526004683, 301.3776157553286], [1659.5599978012335, 452.98835526004683, 293.74597328471987], [1659.5599978012335, 452.98835526004683, 281.3368332039586]], [[1659.5599978012335, 435.01655435828025, 358.5761612794408], [1659.5599978012335, 435.01655435828025, 373.822219405878], [1659.5599978012335, 435.01655435828025, 383.1510640446287], [1659.5599978012335, 435.01655435828025, 386.29703302916613], [1659.5599978012335, 435.01655435828025, 383.1510640446287], [1659.5599978012335, 435.01655435828025, 373.822219405878], [1659.5599978012335, 435.01655435828025, 358.5761612794408]]], [[[1695.8184660330003, 410.2761880928479, 223.94751930404664], [1695.8184660330003, 410.2761880928479, 234.22622575516385], [1695.8184660330003, 410.2761880928479, 240.55548410236335], [1695.8184660330003, 410.2761880928479, 242.69260702078572], [1695.8184660330003, 410.2761880928479, 240.55548410236335], [1695.8184660330003, 410.2761880928479, 234.22622575516385], [1695.8184660330003, 410.2761880928479, 223.94751930404664]], [[1695.8184660330003, 427.3169911953542, 175.6859258526387], [1695.8184660330003, 427.3169911953542, 184.16813799442434], [1695.8184660330003, 427.3169911953542, 189.39904326342608], [1695.8184660330003, 427.3169911953542, 191.16661135779734], [1695.8184660330003, 427.3169911953542, 189.39904326342608], [1695.8184660330003, 427.3169911953542, 184.16813799442434], [1695.8184660330003, 427.3169911953542, 175.6859258526387]], [[1695.8184660330003, 437.75607085173453, 157.42851237311473], [1695.8184660330003, 437.75607085173453, 165.36052987789222], [1695.8184660330003, 437.75607085173453, 170.2580510492267], [1695.8184660330003, 437.75607085173453, 171.9139517829385], [1695.8184660330003, 437.75607085173453, 170.2580510492267], [1695.8184660330003, 437.75607085173453, 165.36052987789222], [1695.8184660330003, 437.75607085173453, 157.42851237311473]], [[1695.8184660330003, 441.259292415536, 166.28155854305737], [1695.8184660330003, 441.259292415536, 174.60183136061832], [1695.8184660330003, 441.259292415536, 179.5592441693589], [1695.8184660330003, 441.259292415536, 181.2343880488234], [1695.8184660330003, 441.259292415536, 179.5592441693589], [1695.8184660330003, 441.259292415536, 174.60183136061832], [1695.8184660330003, 441.259292415536, 166.28155854305737]], [[1695.8184660330003, 437.75607085173453, 207.28978729502742], [1695.8184660330003, 437.75607085173453, 217.06747160124405], [1695.8184660330003, 437.75607085173453, 223.02111898185618], [1695.8184660330003, 437.75607085173453, 225.00015459227012], [1695.8184660330003, 437.75607085173453, 223.02111898185618], [1695.8184660330003, 437.75607085173453, 217.06747160124405], [1695.8184660330003, 437.75607085173453, 207.28978729502742]], [[1695.8184660330003, 427.3169911953542, 269.23119427730853], [1695.8184660330003, 427.3169911953542, 281.1849532749659], [1695.8184660330003, 427.3169911953542, 288.48396060211394], [1695.8184660330003, 427.3169911953542, 290.946982683415], [1695.8184660330003, 427.3169911953542, 288.48396060211394], [1695.8184660330003, 427.3169911953542, 281.1849532749659], [1695.8184660330003, 427.3169911953542, 269.23119427730853]], [[1695.8184660330003, 410.2761880928479, 345.4285189480338], [1695.8184660330003, 410.2761880928479, 360.178765312688], [1695.8184660330003, 410.2761880928479, 369.2045745976681], [1695.8184660330003, 410.2761880928479, 372.2336819864633], [1695.8184660330003, 410.2761880928479, 369.2045745976681], [1695.8184660330003, 410.2761880928479, 360.178765312688], [1695.8184660330003, 410.2761880928479, 345.4285189480338]]], [[[1708.0171030711763, 424.36696995958596, 228.10055166332202], [1708.0171030711763, 424.36696995958596, 238.57289604602258], [1708.0171030711763, 424.36696995958596, 245.02144646082303], [1708.0171030711763, 424.36696995958596, 247.1778306376331], [1708.0171030711763, 424.36696995958596, 245.02144646082303], [1708.0171030711763, 424.36696995958596, 238.57289604602258], [1708.0171030711763, 424.36696995958596, 228.10055166332202]], [[1708.0171030711763, 441.9575140131119, 179.95679447981723], [1708.0171030711763, 441.9575140131119, 188.6466257220589], [1708.0171030711763, 441.9575140131119, 194.00559320037158], [1708.0171030711763, 441.9575140131119, 195.81643884606126], [1708.0171030711763, 441.9575140131119, 194.00559320037158], [1708.0171030711763, 441.9575140131119, 188.6466257220589], [1708.0171030711763, 441.9575140131119, 179.95679447981723]], [[1708.0171030711763, 452.7124759381096, 161.7787566063145], [1708.0171030711763, 452.7124759381096, 169.92920704265893], [1708.0171030711763, 452.7124759381096, 174.89286338673196], [1708.0171030711763, 452.7124759381096, 176.52418566916333], [1708.0171030711763, 452.7124759381096, 174.89286338673196], [1708.0171030711763, 452.7124759381096, 169.92920704265893], [1708.0171030711763, 452.7124759381096, 161.7787566063145]], [[1708.0171030711763, 456.33784236851665, 170.82029630296321], [1708.0171030711763, 456.33784236851665, 179.17087191416965], [1708.0171030711763, 456.33784236851665, 184.2588999752033], [1708.0171030711763, 456.33784236851665, 185.97818400838088], [1708.0171030711763, 456.33784236851665, 184.2588999752033], [1708.0171030711763, 456.33784236851665, 179.17087191416965], [1708.0171030711763, 456.33784236851665, 170.82029630296321]], [[1708.0171030711763, 452.7124759381096, 211.80474115501082], [1708.0171030711763, 452.7124759381096, 221.76147020893154], [1708.0171030711763, 452.7124759381096, 227.74880650569906], [1708.0171030711763, 452.7124759381096, 229.77045048572253], [1708.0171030711763, 452.7124759381096, 227.74880650569906], [1708.0171030711763, 452.7124759381096, 221.76147020893154], [1708.0171030711763, 452.7124759381096, 211.80474115501082]], [[1708.0171030711763, 441.9575140131119, 273.749168722414], [1708.0171030711763, 441.9575140131119, 285.81705372713026], [1708.0171030711763, 441.9575140131119, 293.23869511471133], [1708.0171030711763, 441.9575140131119, 295.7431124517755], [1708.0171030711763, 441.9575140131119, 293.23869511471133], [1708.0171030711763, 441.9575140131119, 285.81705372713026], [1708.0171030711763, 441.9575140131119, 273.749168722414]], [[1708.0171030711763, 424.36696995958596, 349.7734460789304], [1708.0171030711763, 424.36696995958596, 364.71319447187744], [1708.0171030711763, 424.36696995958596, 373.8139340632733], [1708.0171030711763, 424.36696995958596, 376.8816544926401], [1708.0171030711763, 424.36696995958596, 373.8139340632733], [1708.0171030711763, 424.36696995958596, 364.71319447187744], [1708.0171030711763, 424.36696995958596, 349.7734460789304]]], [[[1695.8184660330003, 478.4097608630148, 253.38189378736982], [1695.8184660330003, 478.4097608630148, 264.76402438300573], [1695.8184660330003, 478.4097608630148, 271.7680814411196], [1695.8184660330003, 478.4097608630148, 274.12187906677093], [1695.8184660330003, 478.4097608630148, 271.7680814411196], [1695.8184660330003, 478.4097608630148, 264.76402438300573], [1695.8184660330003, 478.4097608630148, 253.38189378736982]], [[1695.8184660330003, 498.0287421095191, 203.9730544309592], [1695.8184660330003, 498.0287421095191, 213.59252228854075], [1695.8184660330003, 498.0287421095191, 219.5206832167516], [1695.8184660330003, 498.0287421095191, 221.49435611572085], [1695.8184660330003, 498.0287421095191, 219.5206832167516], [1695.8184660330003, 498.0287421095191, 213.59252228854075], [1695.8184660330003, 498.0287421095191, 203.9730544309592]], [[1695.8184660330003, 510.065468049559, 185.49737246352478], [1695.8184660330003, 510.065468049559, 194.45658619296904], [1695.8184660330003, 510.065468049559, 199.88817761405505], [1695.8184660330003, 510.065468049559, 201.70967361960578], [1695.8184660330003, 510.065468049559, 199.88817761405505], [1695.8184660330003, 510.065468049559, 194.45658619296904], [1695.8184660330003, 510.065468049559, 185.49737246352478]], [[1695.8184660330003, 514.068441411911, 195.1731220846523], [1695.8184660330003, 514.068441411911, 204.39611736399013], [1695.8184660330003, 514.068441411911, 210.06622092663005], [1695.8184660330003, 514.068441411911, 211.9815333942285], [1695.8184660330003, 514.068441411911, 210.06622092663005], [1695.8184660330003, 514.068441411911, 204.39611736399013], [1695.8184660330003, 514.068441411911, 195.1731220846523]], [[1695.8184660330003, 510.065468049559, 237.84541493402003], [1695.8184660330003, 510.065468049559, 248.7151896500984], [1695.8184660330003, 510.065468049559, 255.28722626599017], [1695.8184660330003, 510.065468049559, 257.5055574557286], [1695.8184660330003, 510.065468049559, 255.28722626599017], [1695.8184660330003, 510.065468049559, 248.7151896500984], [1695.8184660330003, 510.065468049559, 237.84541493402003]], [[1695.8184660330003, 498.0287421095191, 301.88463846677166], [1695.8184660330003, 498.0287421095191, 314.98888885495313], [1695.8184660330003, 498.0287421095191, 323.03687113704433], [1695.8184660330003, 498.0287421095191, 325.7519415098369], [1695.8184660330003, 498.0287421095191, 323.03687113704433], [1695.8184660330003, 498.0287421095191, 314.98888885495313], [1695.8184660330003, 498.0287421095191, 301.88463846677166]], [[1695.8184660330003, 478.4097608630148, 380.8258201374371], [1695.8184660330003, 478.4097608630148, 396.97515149490476], [1695.8184660330003, 478.4097608630148, 406.72557529789543], [1695.8184660330003, 478.4097608630148, 409.9966674833769], [1695.8184660330003, 478.4097608630148, 406.72557529789543], [1695.8184660330003, 478.4097608630148, 396.97515149490476], [1695.8184660330003, 478.4097608630148, 380.8258201374371]]], [[[1659.5599978012335, 558.8580061088529, 289.9383561636752], [1659.5599978012335, 558.8580061088529, 302.7305458938296], [1659.5599978012335, 558.8580061088529, 310.45898458009003], [1659.5599978012335, 558.8580061088529, 313.0662189840048], [1659.5599978012335, 558.8580061088529, 310.45898458009003], [1659.5599978012335, 558.8580061088529, 302.7305458938296], [1659.5599978012335, 558.8580061088529, 289.9383561636752]], [[1659.5599978012335, 581.2879611447653, 238.95497264383383], [1659.5599978012335, 581.2879611447653, 249.84975530366975], [1659.5599978012335, 581.2879611447653, 256.45231880042707], [1659.5599978012335, 581.2879611447653, 258.6809569491767], [1659.5599978012335, 581.2879611447653, 256.45231880042707], [1659.5599978012335, 581.2879611447653, 249.84975530366975], [1659.5599978012335, 581.2879611447653, 238.95497264383383]], [[1659.5599978012335, 595.0384564317875, 219.69972808016627], [1659.5599978012335, 595.0384564317875, 229.80247418058372], [1659.5599978012335, 595.0384564317875, 236.01035543251393], [1659.5599978012335, 595.0384564317875, 238.10648494918175], [1659.5599978012335, 595.0384564317875, 236.01035543251393], [1659.5599978012335, 595.0384564317875, 229.80247418058372], [1659.5599978012335, 595.0384564317875, 219.69972808016627]], [[1659.5599978012335, 599.6514586989347, 230.21596334378583], [1659.5599978012335, 599.6514586989347, 240.78695865187774], [1659.5599978012335, 599.6514586989347, 247.27302718592114], [1659.5599978012335, 599.6514586989347, 249.42048184434412], [1659.5599978012335, 599.6514586989347, 247.27302718592114], [1659.5599978012335, 599.6514586989347, 240.78695865187774], [1659.5599978012335, 599.6514586989347, 230.21596334378583]], [[1659.5599978012335, 595.0384564317875, 275.4320234703137], [1659.5599978012335, 595.0384564317875, 287.57557985449534], [1659.5599978012335, 595.0384564317875, 295.0437875050777], [1659.5599978012335, 595.0384564317875, 297.5639233835773], [1659.5599978012335, 595.0384564317875, 295.0437875050777], [1659.5599978012335, 595.0384564317875, 287.57557985449534], [1659.5599978012335, 595.0384564317875, 275.4320234703137]], [[1659.5599978012335, 581.2879611447653, 342.73837565633147], [1659.5599978012335, 581.2879611447653, 357.3713177332207], [1659.5599978012335, 581.2879611447653, 366.35049013610836], [1659.5599978012335, 581.2879611447653, 369.3556936604666], [1659.5599978012335, 581.2879611447653, 366.35049013610836], [1659.5599978012335, 581.2879611447653, 357.3713177332207], [1659.5599978012335, 581.2879611447653, 342.73837565633147]], [[1659.5599978012335, 558.8580061088529, 426.2316724710651], [1659.5599978012335, 558.8580061088529, 443.8886127214687], [1659.5599978012335, 558.8580061088529, 454.6915246573938], [1659.5599978012335, 558.8580061088529, 458.33305993631325], [1659.5599978012335, 558.8580061088529, 454.6915246573938], [1659.5599978012335, 558.8580061088529, 443.8886127214687], [1659.5599978012335, 558.8580061088529, 426.2316724710651]]], [[[1600.2776271675173, 661.1067086708474, 330.0827676456563], [1600.2776271675173, 661.1067086708474, 344.2187288928402], [1600.2776271675173, 661.1067086708474, 352.8708464286138], [1600.2776271675173, 661.1067086708474, 355.7889492344381], [1600.2776271675173, 661.1067086708474, 352.8708464286138], [1600.2776271675173, 661.1067086708474, 344.2187288928402], [1600.2776271675173, 661.1067086708474, 330.0827676456563]], [[1600.2776271675173, 687.0998757626448, 277.503740591647], [1600.2776271675173, 687.0998757626448, 289.74046575882585], [1600.2776271675173, 687.0998757626448, 297.2660073603163], [1600.2776271675173, 687.0998757626448, 299.80549647402904], [1600.2776271675173, 687.0998757626448, 297.2660073603163], [1600.2776271675173, 687.0998757626448, 289.74046575882585], [1600.2776271675173, 687.0998757626448, 277.503740591647]], [[1600.2776271675173, 702.8792208058094, 257.24735836485985], [1600.2776271675173, 702.8792208058094, 268.80633333954313], [1600.2776271675173, 702.8792208058094, 275.87363993678724], [1600.2776271675173, 702.8792208058094, 278.2269358347604], [1600.2776271675173, 702.8792208058094, 275.87363993678724], [1600.2776271675173, 702.8792208058094, 268.80633333954313], [1600.2776271675173, 702.8792208058094, 257.24735836485985]], [[1600.2776271675173, 708.1928518634936, 268.9390547534912], [1600.2776271675173, 708.1928518634936, 280.88558175362886], [1600.2776271675173, 708.1928518634936, 288.1766645416789], [1600.2776271675173, 708.1928518634936, 290.63701169318495], [1600.2776271675173, 708.1928518634936, 288.1766645416789], [1600.2776271675173, 708.1928518634936, 280.88558175362886], [1600.2776271675173, 708.1928518634936, 268.9390547534912]], [[1600.2776271675173, 702.8792208058094, 316.57737317929366], [1600.2776271675173, 702.8792208058094, 330.3209033190017], [1600.2776271675173, 702.8792208058094, 338.6658366576471], [1600.2776271675173, 702.8792208058094, 341.46406608716484], [1600.2776271675173, 702.8792208058094, 338.6658366576471], [1600.2776271675173, 702.8792208058094, 330.3209033190017], [1600.2776271675173, 702.8792208058094, 316.57737317929366]], [[1600.2776271675173, 687.0998757626448, 387.5626350655821], [1600.2776271675173, 687.0998757626448, 403.8984891715214], [1600.2776271675173, 687.0998757626448, 413.7732946683974], [1600.2776271675173, 687.0998757626448, 417.1022347571524], [1600.2776271675173, 687.0998757626448, 413.7732946683974], [1600.2776271675173, 687.0998757626448, 403.8984891715214], [1600.2776271675173, 687.0998757626448, 387.5626350655821]], [[1600.2776271675173, 661.1067086708474, 475.8763314428264], [1600.2776271675173, 661.1067086708474, 495.3893491523572], [1600.2776271675173, 661.1067086708474, 507.3610203271075], [1600.2776271675173, 661.1067086708474, 511.3946157634713], [1600.2776271675173, 661.1067086708474, 507.3610203271075], [1600.2776271675173, 661.1067086708474, 495.3893491523572], [1600.2776271675173, 661.1067086708474, 475.8763314428264]]]]


def MICO_wind(config, wind):
    g.printStat("Starting MICO_wind with " + config + " as configuration")
    g.printStat("   Wind blows " + str(wind["angle"]) + " degrees with a speed of " + str(wind["speed"]) + " m/s")

    l.createCSV()

    totalMax = {'production': 0, 'action': None, "OJA": 0}

    infra = i.loadInfrastructureDB(config)

    nTurbines = len(infra)
    nEpisodes = 500000

    CG = cg.createCG(infra, g.nActions, wind)

    g.printStat("Starting learning session: " + str(nEpisodes) + " episodes")

#    CG[1][2]['valRules'][1][1] = 500
#    CG[2][3]['valRules'][2][2] = 500000


    for episode in xrange(1, 1 + nEpisodes):

        g.printStat("   Episode " + str(episode))

        # Find optimal joint action (OJA) using variable elimination

    #    OJA = map(lambda x: g.indexAction(x) ,cg.findOJA(CG, g.nActions))

        OJA = cg.findOJA(CG, g.nActions)
        OJAProd = cg.findOJAProd(CG, g.nActions)

        # Chose the OJA action with a chance of (1 - epsilon) or chose a random
        # action.

        jointAction = None

        if r.random() < (1 - g.epsilon):
            jointAction = OJA
            g.printStat("       Using OJA")
        else:
            jointAction = map(lambda x: r.randint(0, g.nActions - 1), np.zeros(nTurbines))
        # //    jointAction = map(lambda x: x + r.randint(-2, 2), OJA)
        #    jointAction = np.zeros(nTurbines)
        #    counter = 0
        #    for action in jointAction:
        #        exploringStep = 1
        #        rand = r.randint(-exploringStep, exploringStep)
        #        print rand
        #        if OJA[counter] + rand < 0:
        #            jointAction[counter] = OJA[counter] + abs(rand)
        #        elif OJA[counter] + rand > (g.nActions - 1):
        #            jointAction[counter] = OJA[counter] - abs(rand)
        #        else:
        #            jointAction[counter] = OJA[counter] + rand
        #        counter += 1
        #    jointAction = map(lambda x: int(x), jointAction)


            g.printStat("       Using random action")

        g.printStat("       Joint action: " + str(map(lambda x: g.indexAction(x), jointAction)))

        #test
    #    for edge in CG.edges():
    #        CG[edge[0]][edge[1]]['valRules'][1][0] = np.random.random() * 1000
    #        CG[edge[0]][edge[1]]['valRules'][1][5] = np.random.random() * 1000
    #        CG[edge[0]][edge[1]]['valRules'][4][6] = np.random.random() * 1000
    #        CG[edge[0]][edge[1]]['valRules'][6][6] = np.random.random() * 1000
            #valRules[edge[0]][edge[1]] = np.random.random()
    #        print edge
            #print valRules
    #        print "haha"

        # Validate jointAction in WISDEM and receive the power productions

        Q = Query()

        turbines = infra.all()

        for turbine in turbines:
            turbine['yaw'] = turbine['yaw'] + g.indexAction(jointAction[turbine['id'] - 1])


        #powerProductions = f.calcProduction(wind, turbines)
    #    powerProductions = np.array([500 + np.random.normal (0, 0.1), 500 + np.random.normal(0, 0.1), 500 + np.random.normal(0, 0.1)])
        #powerProductions = np.array([500, 500, 500])
        powerProductions = preCalcs[jointAction[0]][jointAction[1]][jointAction[2]]
        powerProductions = map(lambda x: x + np.random.normal (0, 0.1), powerProductions)
        powerProductions = np.array(powerProductions)


        total = np.sum(powerProductions)
        if total > totalMax['production']:
            totalMax['production'] = total
            totalMax['action'] = jointAction
            totalMax['OJA'] = OJA


        for edge in CG.edges():
            From = edge[0]
            To = edge[1]
            turbine1 = infra.search(Q.id == From)[0]
            turbine2 = infra.search(Q.id == To)[0]
            actionTurbine1 = jointAction[turbine1['id'] - 1]
            actionTurbine2 = jointAction[turbine2['id'] - 1]
            CG[From][To]['productions'][actionTurbine1][actionTurbine2] = powerProductions[turbine1['id'] - 1] + powerProductions[turbine2['id'] - 1]

            # Update valRules
            print "PRODS: "
            print CG[From][To]['productions']
            discSum = cg.discountedSum(edge, [jointAction[From - 1], jointAction[To - 1]], powerProductions, OJA, CG)
            valRules = CG[edge[0]][edge[1]]['valRules']

            normalizedFrom = jointAction[From - 1]
            normalizedTo = jointAction[To - 1]

            adjustedProduction = valRules[normalizedFrom][normalizedTo] + discSum
            valRules[normalizedFrom][normalizedTo] = adjustedProduction

            print powerProductions
            print valRules


            data = [episode]
            for element in OJA:
                data.append(element)
            for element in jointAction:
                data.append(element)
            for element in powerProductions:
                data.append(element)

            #data = [episode, OJA, jointAction, powerProductions]

        l.appendCSV([data])

        g.printStat("       Total power production: " + str(powerProductions.sum()))

        print totalMax
        print "OJA: " + str(OJA)

    g.printStat("Done!")

g.printStat("Done loading modules")

MICO_wind("three_park.json", wind)
